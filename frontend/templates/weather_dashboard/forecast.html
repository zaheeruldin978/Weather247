{% extends 'base.html' %}
{% load static %}

{% block title %}AI Weather Forecast - Weather-247{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8" x-data="aiForecast" x-init="loadForecast()" x-cloak>
    <!-- Loading Overlay -->
    <div x-show="loading" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-lg text-gray-600">Generating AI forecast...</p>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header (Compare Page Style) -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-600 via-magenta-500 to-pink-500 rounded-2xl shadow-xl border border-purple-400/20 hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">AI Weather Forecast</h1>
                        <p class="text-gray-600 mt-1">Advanced weather predictions and insights powered by AI</p>
                    </div>
    </div>

                <!-- Current Status Badge -->
                <div x-show="forecastData && !forecastData.error" class="flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <span class="font-medium">Showing weather for <span class="font-bold" x-text="forecastData.city"></span></span>
                </div>
            </div>
        </div>

    <!-- City Selector with Search -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 mb-8">
            <div class="flex flex-col sm:flex-row gap-4 items-end">
                <div class="flex-1 relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search City for AI Forecast</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            x-model="searchQuery" 
                            @input="searchCities()"
                            @focus="showSearchResults = true"
                            @blur="setTimeout(() => showSearchResults = false, 200)"
                            @keyup.enter="searchAndSelectCity()"
                            placeholder="Type city name (e.g., London, New York, Tokyo)"
                            class="w-full px-4 py-3 h-[52px] border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-10"
                        >
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        
                        <!-- Search Status -->
                        <div x-show="searchQuery && !showSearchResults" class="absolute inset-y-0 right-0 pr-12 flex items-center">
                            <svg class="h-5 w-5 text-blue-500 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </div>
                        
                        <!-- Search Results Dropdown -->
                        <div x-show="showSearchResults && filteredCities.length > 0" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform scale-95"
                             x-transition:enter-end="opacity-100 transform scale-100"
                             class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <template x-for="city in filteredCities" :key="city">
                                <div @click="selectCity(city)" 
                                     class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                                    <div class="font-medium text-gray-900" x-text="city"></div>
                                </div>
                        </template>
                        </div>
                    </div>
            </div>
                <button @click="loadForecast()" :disabled="loading" class="bg-gradient-to-r from-purple-600 via-magenta-500 to-pink-500 hover:from-purple-700 hover:via-magenta-600 hover:to-pink-600 disabled:opacity-50 text-white px-8 h-[52px] rounded-xl font-medium transition-all duration-300 transform hover:scale-105 disabled:transform-none shadow-lg hover:shadow-xl border border-purple-400/20 flex items-center justify-center leading-none">
                    <span x-show="!loading">Generate AI Forecast</span>
                    <span x-show="loading" class="flex items-center gap-2">
                        <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        AI Processing...
                    </span>
                </button>
        </div>
    </div>

        <!-- AI Forecast Display -->
        <div x-show="forecastData" class="space-y-8">
            <!-- Error Display -->
            <div x-show="forecastData.error" class="bg-red-50 border border-red-200 rounded-2xl p-6">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-red-800">Error Loading Weather Data</h3>
                        <p class="text-red-600 mt-1" x-text="forecastData.error"></p>
            </div>
        </div>
    </div>

            <!-- Enhanced Beautiful Weather Card with Day/Night -->
            <div x-show="!forecastData.error" class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <!-- Dynamic Day/Night Header -->
                <div class="relative overflow-hidden" 
                     x-bind:class="forecastData.current ? (isNightBySunTimes(forecastData.current.sunrise, forecastData.current.sunset) ? 'bg-gradient-to-r from-indigo-900 via-purple-800 to-blue-900' : 'bg-gradient-to-r from-orange-400 via-pink-500 to-purple-600') : 'bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-700'">
                    
                    <!-- Animated Background Pattern -->
                    <div class="absolute inset-0 opacity-10">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-white rounded-full -mr-12 -mt-12 animate-pulse"></div>
                        <div class="absolute bottom-0 left-0 w-20 h-20 bg-white rounded-full -ml-10 -mb-10 animate-pulse" style="animation-delay: 1s;"></div>
                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-white rounded-full opacity-30 animate-pulse" style="animation-delay: 2s;"></div>
                    </div>
                    
                    <!-- Day/Night Indicator -->
                    <!-- Day/Night chip intentionally hidden -->
                    
                    <div class="relative z-10 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center border border-white/30 shadow-lg">
                                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-white drop-shadow-sm" x-text="forecastData.current ? forecastData.current.city : '--'"></h2>
                                    <p class="text-white/90 text-sm font-medium" x-text="forecastData.current ? (isNightBySunTimes(forecastData.current.sunrise, forecastData.current.sunset) ? 'Night Weather' : 'Day Weather') : 'Current Weather'"></p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-bold text-white drop-shadow-sm" x-text="forecastData.current ? Math.round(forecastData.current.temperature) + 'Â°C' : '--'"></div>
                                <div class="text-white/90 text-sm capitalize font-medium" x-text="forecastData.current ? forecastData.current.description : '--'"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                        <!-- Enhanced Weather Icon & Feels Like -->
                        <div class="flex flex-col items-center space-y-4">
                            <div class="relative">
                                <!-- Dynamic Weather Icon with Day/Night -->
                                <div x-show="forecastData && forecastData.current"
                                     x-html="renderWeatherIcon(forecastData.current.description, isNightBySunTimes(forecastData.current.sunrise, forecastData.current.sunset), 'w-24 h-24', '')"
                                     class="mx-auto drop-shadow-2xl"></div>
                                
                                <!-- Enhanced Glow Effect -->
                                <div class="absolute inset-0 rounded-full blur-xl scale-125 opacity-40"
                                     x-bind:class="forecastData.current ? (isNightBySunTimes(forecastData.current.sunrise, forecastData.current.sunset) ? 'bg-blue-300/30' : 'bg-yellow-300/30') : 'bg-blue-200/20'"></div>
                                
                                <!-- Animated Rings -->
                                <div class="absolute inset-0 rounded-full border-2 border-white/20 animate-ping scale-110"></div>
                                <div class="absolute inset-0 rounded-full border border-white/30 scale-125"></div>
                            </div>
                            
                            <!-- Enhanced Feels Like Card -->
                            <div class="text-center bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl p-4 border border-blue-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                                <div class="text-xs text-blue-600 mb-2 font-semibold uppercase tracking-wide">Feels Like</div>
                                <div class="text-2xl font-bold text-blue-900" x-text="forecastData.current ? Math.round(forecastData.current.feels_like) + 'Â°C' : '--'"></div>
                                <div class="text-xs text-blue-500 mt-1" x-text="forecastData.current ? (forecastData.current.feels_like > forecastData.current.temperature ? 'Warmer' : forecastData.current.feels_like < forecastData.current.temperature ? 'Cooler' : 'Same') : '--'"></div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Key Metrics -->
                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-blue-50 via-blue-100 to-indigo-100 rounded-xl p-3 border border-blue-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 min-h-[120px] flex flex-col justify-between">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-blue-800 uppercase tracking-wide">Humidity</span>
                                </div>
                                <div class="text-lg font-bold text-blue-900" x-text="forecastData.current ? forecastData.current.humidity + '%' : '--'"></div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-50 via-emerald-100 to-teal-100 rounded-xl p-3 border border-green-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 min-h-[120px] flex flex-col justify-between">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center shadow-md">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-green-800 uppercase tracking-wide">Wind</span>
                                </div>
                                <div class="text-lg font-bold text-green-900" x-text="forecastData.current ? forecastData.current.wind_speed + ' m/s' : '--'"></div>
                            </div>
                        </div>
                        
                        <!-- Enhanced More Metrics -->
                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-purple-50 via-violet-100 to-fuchsia-100 rounded-xl p-3 border border-purple-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 min-h-[120px] flex flex-col justify-between">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center shadow-md">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-purple-800 uppercase tracking-wide">Pressure</span>
                                </div>
                                <div class="text-lg font-bold text-purple-900" x-text="forecastData.current ? forecastData.current.pressure + ' hPa' : '--'"></div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-orange-50 via-amber-100 to-yellow-100 rounded-xl p-3 border border-orange-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 min-h-[120px] flex flex-col justify-between">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg flex items-center justify-center shadow-md">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-orange-800 uppercase tracking-wide">UV Index</span>
                                </div>
                                <div class="text-lg font-bold text-orange-900" x-text="forecastData.current ? (forecastData.current.uv_index || 'N/A') : 'N/A'"></div>
                                <div class="text-xs text-orange-600 mt-1" x-text="forecastData.current && forecastData.current.uv_index ? getUVLevel(forecastData.current.uv_index) : 'No Data'"></div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Time Info Cards -->
                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-blue-50 via-indigo-100 to-purple-100 rounded-xl p-3 border border-blue-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 min-h-[120px] flex flex-col justify-between">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md">
                                        <span class="text-white text-base" x-text="forecastData.current ? (isNightBySunTimes(forecastData.current.sunrise, forecastData.current.sunset) ? 'ðŸŒ™' : 'â˜€ï¸') : '--'"></span>
                                    </div>
                                    <span class="text-xs font-bold text-blue-800 uppercase tracking-wide">Day/Night</span>
                                </div>
                                <div class="text-lg font-bold text-blue-900" x-text="forecastData.current ? (isNightBySunTimes(forecastData.current.sunrise, forecastData.current.sunset) ? 'Night' : 'Day') : '--'"></div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-amber-50 via-orange-100 to-red-100 rounded-xl p-3 border border-amber-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 min-h-[120px] flex flex-col justify-between">
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="w-7 h-7 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-md">
                                        <span class="text-white text-base">ðŸŒ…</span>
                                    </div>
                                    <span class="text-xs font-bold text-amber-800 uppercase tracking-wide">Sun Times</span>
                                </div>
                                <div class="text-lg font-bold text-amber-900" x-text="forecastData.current ? new Date(forecastData.current.sunrise * 1000).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : '--'"></div>
                                <div class="text-xs text-amber-600 mt-1">Sunrise & Sunset</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced 24-Hour Forecast Chart -->
            <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900">24-Hour AI Forecast</h3>
                            <p class="text-gray-600">Detailed hourly predictions powered by machine learning</p>
                        </div>
                    </div>
                    
                    <!-- Chart Legend -->
                    <div class="hidden lg:flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-gray-600">Temperature</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-gray-600">Humidity</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                            <span class="text-gray-600">Wind Speed</span>
                        </div>
                    </div>
                </div>
                
                <div class="h-96 bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-4">
                    <canvas id="forecastChart"></canvas>
        </div>
                
                <!-- Chart Stats -->
                <div x-show="forecastData && forecastData.forecasts" class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 text-center">
                        <div class="text-blue-600 text-sm font-medium mb-1">Max Temp</div>
                        <div class="text-2xl font-bold text-blue-900" x-text="forecastData.forecasts ? Math.max(...forecastData.forecasts.slice(0, 24).map(f => f.temperature)) + 'Â°C' : '--'"></div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-4 text-center">
                        <div class="text-green-600 text-sm font-medium mb-1">Min Temp</div>
                        <div class="text-2xl font-bold text-green-900" x-text="forecastData.forecasts ? Math.min(...forecastData.forecasts.slice(0, 24).map(f => f.temperature)) + 'Â°C' : '--'"></div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-4 text-center">
                        <div class="text-purple-600 text-sm font-medium mb-1">Avg Humidity</div>
                        <div class="text-2xl font-bold text-purple-900" x-text="forecastData.forecasts ? Math.round(forecastData.forecasts.slice(0, 24).reduce((sum, f) => sum + f.humidity, 0) / 24) + '%' : '--'"></div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-4 text-center">
                        <div class="text-orange-600 text-sm font-medium mb-1">Avg Wind</div>
                        <div class="text-2xl font-bold text-orange-900" x-text="forecastData.forecasts ? Math.round(forecastData.forecasts.slice(0, 24).reduce((sum, f) => sum + f.wind_speed, 0) / 24 * 10) / 10 + ' m/s' : '--'"></div>
    </div>
                </div>
            </div>

            <!-- Enhanced Hourly Forecast Cards -->
            <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                                                <div>
                            <h3 class="text-2xl font-bold text-gray-900">Detailed Hourly Predictions</h3>
                            <p class="text-gray-600">AI-powered hourly weather insights with probability analysis</p>
                            <p class="text-sm text-blue-600 font-medium" x-show="forecastData && forecastData.city">
                                <span x-text="'ðŸ• Times shown in ' + getCityTimezone(forecastData.city) + ' timezone'"></span>
                            </p>
        </div>
    </div>

                    <!-- Time Range Selector -->
                    <div class="flex items-center gap-2 bg-gray-100 rounded-xl p-1">
                        <button @click="selectedHours = 6" :class="selectedHours === 6 ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">6 Hours</button>
                        <button @click="selectedHours = 12" :class="selectedHours === 12 ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">12 Hours</button>
                        <button @click="selectedHours = 24" :class="selectedHours === 24 ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-600'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">24 Hours</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" x-show="forecastData && forecastData.forecasts">
                    <template x-for="(forecast, index) in forecastData.forecasts.slice(0, selectedHours)" :key="forecast.datetime">
                                                <div class="group bg-gradient-to-br from-white to-gray-50 hover:from-blue-50 hover:to-indigo-100 rounded-2xl p-4 text-center border border-gray-200 hover:border-blue-300 transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                            <!-- Time Header -->
                            <div class="mb-3">
                                <div class="text-lg font-bold text-gray-900 mb-1" x-text="forecast.time || new Date(forecast.datetime).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})"></div>
                                <div class="text-sm text-gray-500" x-text="forecast.date || new Date(forecast.datetime).toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric'})"></div>
                            </div>
                            
                            <!-- Weather Icon -->
                            <div class="mb-3">
                                <div x-html="renderWeatherIcon(forecast.description, isNightBySunTimes(forecastData.current?.sunrise, forecastData.current?.sunset), 'w-14 h-14', '')" class="mx-auto"></div>
                            </div>
                            
                            <!-- Temperature -->
                            <div class="text-2xl font-bold text-gray-900 mb-2" x-text="forecast.temperature + 'Â°C'"></div>
                            
                            <!-- Description -->
                            <div class="text-sm text-gray-600 mb-3 capitalize" x-text="forecast.description"></div>
                            
                            <!-- Weather Metrics -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">Feels Like</span>
                                    <span class="font-semibold text-gray-900" x-text="forecast.feels_like ? forecast.feels_like + 'Â°C' : '--'"></span>
                                </div>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">Humidity</span>
                                    <span class="font-semibold text-gray-900" x-text="forecast.humidity + '%'"></span>
                                </div>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">Wind</span>
                                    <span class="font-semibold text-gray-900" x-text="forecast.wind_speed + ' m/s'"></span>
                                </div>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-gray-500">Pressure</span>
                                    <span class="font-semibold text-gray-900" x-text="forecast.pressure + ' hPa'"></span>
                                </div>
                            </div>
                            
                            <!-- Rain Probability -->
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    <span class="text-sm font-medium text-blue-600" x-text="'Rain: ' + (forecast.pop || 0) + '%'"></span>
                                </div>
                            </div>
            </div>
                    </template>
        </div>
    </div>

            <!-- AI Confidence Metrics -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-6">AI Prediction Confidence</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-green-600">95%</span>
            </div>
                        <p class="text-sm font-medium text-gray-900">Temperature Accuracy</p>
                        <p class="text-xs text-gray-500">Based on historical patterns</p>
        </div>
                    <div class="text-center">
                        <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-blue-600">88%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-900">Humidity Prediction</p>
                        <p class="text-xs text-gray-500">ML model confidence</p>
                    </div>
                    <div class="text-center">
                        <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl font-bold text-purple-600">92%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-900">Overall Reliability</p>
                        <p class="text-xs text-gray-500">Combined metrics score</p>
            </div>
        </div>
    </div>
</div>

        <!-- Enhanced AI Explanation -->
        <div class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-50 rounded-3xl p-8 mt-8 border border-purple-100">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-600 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-2">How Our AI Forecasting Works</h3>
                <p class="text-gray-600 text-lg">Advanced machine learning algorithms powered by comprehensive weather data</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Machine Learning Models -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-purple-100">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 mb-4">Machine Learning Models</h4>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <span class="text-purple-600 mr-3 mt-1">â€¢</span>
                            <span><strong>RandomForest:</strong> Advanced temperature prediction with 95% accuracy</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-purple-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Neural Networks:</strong> Deep learning for humidity forecasting</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-purple-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Time Series:</strong> Pattern recognition for trend detection</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-purple-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Ensemble Methods:</strong> Combined predictions for reliability</span>
                        </li>
                    </ul>
                </div>
                
                <!-- Data Sources -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-blue-100">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 mb-4">Data Sources</h4>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <span class="text-blue-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Historical Data:</strong> 5+ years of OpenWeather records</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Satellite Imagery:</strong> Real-time cloud cover analysis</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Atmospheric Data:</strong> Pressure, wind, and humidity patterns</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-blue-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Ocean Data:</strong> Temperature and current information</span>
                        </li>
                    </ul>
            </div>
                
                <!-- AI Features -->
                <div class="bg-white rounded-2xl p-6 shadow-lg border border-indigo-100">
                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold text-gray-900 mb-4">AI Features</h4>
                    <ul class="space-y-3 text-gray-600">
                        <li class="flex items-start">
                            <span class="text-indigo-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Real-time Updates:</strong> Live weather data processing</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Pattern Recognition:</strong> Weather trend identification</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Accuracy Metrics:</strong> Confidence scoring for predictions</span>
                        </li>
                        <li class="flex items-start">
                            <span class="text-indigo-600 mr-3 mt-1">â€¢</span>
                            <span><strong>Adaptive Learning:</strong> Continuous model improvement</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Weather Insights & Recommendations -->
    <div x-show="forecastData && !forecastData.error" class="mt-8">
        <div class="relative max-w-[76rem] mx-auto bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 rounded-3xl p-8 md:p-10 border border-emerald-100 shadow-2xl overflow-hidden">
            <!-- Decorative background orbs -->
            <div class="pointer-events-none absolute -top-10 -right-10 w-40 h-40 bg-teal-300/20 rounded-full blur-3xl"></div>
            <div class="pointer-events-none absolute -bottom-10 -left-10 w-32 h-32 bg-emerald-300/20 rounded-full blur-3xl"></div>
            <div class="pointer-events-none absolute top-1/2 left-1/3 w-24 h-24 bg-cyan-300/20 rounded-full blur-2xl"></div>
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <h3 class="text-3xl font-bold bg-gradient-to-r from-emerald-700 via-teal-700 to-cyan-700 bg-clip-text text-transparent mb-2">Weather Insights & Recommendations</h3>
                <p class="text-gray-600 text-lg">AI-powered suggestions for your daily activities</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 relative">
                <!-- Current Conditions Analysis -->
                <div class="bg-white/90 rounded-2xl p-6 shadow-lg border border-emerald-100 backdrop-blur-sm transition-all duration-300 hover:shadow-xl">
                    <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Current Conditions Analysis
                    </h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                            <span class="text-gray-700">Temperature Range</span>
                            <span class="font-semibold text-emerald-600" x-text="forecastData.forecasts ? Math.min(...forecastData.forecasts.slice(0, 24).map(f => f.temperature)) + 'Â°C - ' + Math.max(...forecastData.forecasts.slice(0, 24).map(f => f.temperature)) + 'Â°C' : '--'"></span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                            <span class="text-gray-700">Humidity Trend</span>
                            <span class="font-semibold text-blue-600" x-text="forecastData.forecasts ? (forecastData.forecasts[0].humidity > forecastData.forecasts[23].humidity ? 'Decreasing' : 'Increasing') : '--'"></span>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                            <span class="text-gray-700">Wind Conditions</span>
                            <span class="font-semibold text-purple-600" x-text="forecastData.forecasts ? (Math.max(...forecastData.forecasts.slice(0, 24).map(f => f.wind_speed)) > 10 ? 'Windy' : 'Calm') : '--'"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Recommendations -->
                <div class="bg-white/90 rounded-2xl p-6 shadow-lg border border-emerald-100 backdrop-blur-sm transition-all duration-300 hover:shadow-xl">
                    <h4 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-teal-500" fill="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Activity Recommendations
                    </h4>
                    <div class="space-y-3">
                        <div class="p-3 bg-teal-50 rounded-lg">
                            <div class="font-medium text-teal-800 mb-1">Outdoor Activities</div>
                            <div class="text-sm text-teal-700" x-text="forecastData.current ? (forecastData.current.temperature > 20 && forecastData.current.description.includes('clear') ? 'Perfect for outdoor activities! Enjoy the clear weather.' : 'Consider indoor alternatives due to weather conditions.') : '--'"></div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg">
                            <div class="font-medium text-amber-800 mb-1">Clothing Suggestions</div>
                            <div class="text-sm text-amber-700" x-text="forecastData.current ? (forecastData.current.temperature > 25 ? 'Light clothing recommended' : forecastData.current.temperature > 15 ? 'Moderate clothing suitable' : 'Warm clothing advised') : '--'"></div>
                        </div>
                        <div class="p-3 bg-indigo-50 rounded-lg">
                            <div class="font-medium text-indigo-800 mb-1">Travel Advisory</div>
                            <div class="text-sm text-indigo-700" x-text="forecastData.current ? (forecastData.current.description.includes('rain') || forecastData.current.description.includes('storm') ? 'Travel with caution - adverse weather conditions' : 'Good weather for travel') : '--'"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Alpine.js data and methods
document.addEventListener('alpine:init', () => {
    Alpine.data('aiForecast', () => ({
        selectedCity: 'London',
        searchQuery: '',
        showSearchResults: false,
        filteredCities: [],
        searchResults: [],
        selectedHours: 24,
        forecastData: null,
        loading: false,
        cities: ['London', 'New York', 'Tokyo', 'Sydney', 'Dubai', 'Mumbai', 'Paris', 'Berlin', 'Moscow', 'Beijing', 'Delhi', 'New Delhi', 'Mexico City', 'SÃ£o Paulo', 'Cairo', 'Lagos', 'Johannesburg', 'Nairobi', 'Casablanca', 'Algiers', 'Tunis', 'Tripoli', 'Khartoum', 'Addis Ababa', 'Dar es Salaam', 'Kinshasa', 'Luanda', 'Lusaka', 'Harare', 'Gaborone', 'Windhoek', 'Maputo', 'Antananarivo', 'Port Louis', 'Victoria', 'Moroni', 'Saint-Denis', 'Saint-Denis', 'Port-aux-FranÃ§ais', 'McMurdo Station', 'Vostok Station', 'Amundsen-Scott Station', 'Palmer Station', 'Rothera Station', 'Mawson Station', 'Davis Station', 'Casey Station', 'Dumont d\'Urville Station', 'Concordia Station', 'Halley Station', 'Neumayer Station', 'Troll Station', 'Svea Station', 'Wasa Station', 'Aboa Station', 'Maitri Station', 'Bharati Station', 'Dakshin Gangotri Station', 'Himadri Station', 'Indira Station', 'Maitri Station', 'Bharati Station', 'Dakshin Gangotri Station', 'Himadri Station', 'Indira Station', 'Karachi', 'Lahore', 'Islamabad', 'Gujranwala', 'Faisalabad', 'Rawalpindi', 'Multan', 'Peshawar', 'Quetta', 'Sialkot', 'Bahawalpur', 'Sargodha', 'Sukkur', 'Jhang', 'Sheikhupura', 'Rahim Yar Khan', 'Gujrat', 'Mardan', 'Kasur', 'Dera Ghazi Khan', 'Sahiwal', 'Nawabshah', 'Mirpur Khas', 'Okara', 'Bangalore', 'Hyderabad', 'Chennai', 'Kolkata', 'Ahmedabad', 'Pune', 'Jaipur', 'Surat', 'Lucknow', 'Kanpur', 'Nagpur', 'Indore', 'Thane', 'Bhopal', 'Patna', 'Vadodara', 'Ghaziabad', 'Ludhiana', 'Agra', 'Nashik', 'Faridabad', 'Meerut', 'Rajkot', 'Kalyan', 'Vasai', 'Varanasi', 'Srinagar', 'Aurangabad', 'Navi Mumbai', 'Solapur'],
        
        // Delegate to global icon helper (with night support)
        getWeatherIcon(condition, isNight = false) {
            return window.getWeatherIcon(condition, !!isNight);
        },
        
        init() {
            console.log('AI Forecast component initialized');
            this.filteredCities = this.cities;
            // Initialize with London data
            this.loadForecast();
        },
        
        searchCities() {
            console.log('ðŸ” Searching for:', this.searchQuery);
            
            if (!this.searchQuery.trim()) {
                this.filteredCities = this.cities;
                this.searchResults = [];
                this.showSearchResults = false;
                return;
            }
            
            const query = this.searchQuery.toLowerCase();
            this.filteredCities = this.cities.filter(city => 
                city.toLowerCase().includes(query)
            );
            
            // Update searchResults for the compare page style dropdown
            this.searchResults = this.filteredCities;
            
            console.log('ðŸ“‹ Filtered cities:', this.filteredCities);
            this.showSearchResults = this.filteredCities.length > 0;
        },
        
        searchAndSelectCity() {
            const query = this.searchQuery.trim().toLowerCase();
            if (!query) return;
            
            console.log('ðŸ” Searching for city:', query);
            
            // Try to find exact match first
            let exactMatch = this.cities.find(city => 
                city.toLowerCase() === query
            );
            
            // If no exact match, try common variations
            if (!exactMatch) {
                const variations = {
                    'new delhi': 'New Delhi',
                    'delhi': 'Delhi',
                    'mumbai': 'Mumbai',
                    'bombay': 'Mumbai',
                    'kolkata': 'Kolkata',
                    'calcutta': 'Kolkata',
                    'chennai': 'Chennai',
                    'madras': 'Chennai',
                    'bangalore': 'Bangalore',
                    'bengaluru': 'Bangalore',
                    'hyderabad': 'Hyderabad',
                    'ahmedabad': 'Ahmedabad',
                    'pune': 'Pune',
                    'jaipur': 'Jaipur',
                    'surat': 'Surat',
                    'lucknow': 'Lucknow',
                    'kanpur': 'Kanpur',
                    'nagpur': 'Nagpur',
                    'indore': 'Indore',
                    'thane': 'Thane',
                    'bhopal': 'Bhopal',
                    'patna': 'Patna',
                    'vadodara': 'Vadodara',
                    'ghaziabad': 'Ghaziabad',
                    'ludhiana': 'Ludhiana',
                    'agra': 'Agra',
                    'nashik': 'Nashik',
                    'faridabad': 'Faridabad',
                    'meerut': 'Meerut',
                    'rajkot': 'Rajkot',
                    'kalyan': 'Kalyan',
                    'vasai': 'Vasai',
                    'varanasi': 'Varanasi',
                    'srinagar': 'Srinagar',
                    'aurangabad': 'Aurangabad',
                    'navi mumbai': 'Navi Mumbai',
                    'solapur': 'Solapur',
                    'karachi': 'Karachi',
                    'lahore': 'Lahore',
                    'islamabad': 'Islamabad',
                    'gujranwala': 'Gujranwala',
                    'faisalabad': 'Faisalabad',
                    'rawalpindi': 'Rawalpindi',
                    'multan': 'Multan',
                    'peshawar': 'Peshawar',
                    'quetta': 'Quetta',
                    'sialkot': 'Sialkot',
                    'bahawalpur': 'Bahawalpur',
                    'sargodha': 'Sargodha',
                    'sukkur': 'Sukkur',
                    'jhang': 'Jhang',
                    'sheikhupura': 'Sheikhupura',
                    'rahim yar khan': 'Rahim Yar Khan',
                    'gujrat': 'Gujrat',
                    'mardan': 'Mardan',
                    'kasur': 'Kasur',
                    'dera ghazi khan': 'Dera Ghazi Khan',
                    'sahiwal': 'Sahiwal',
                    'nawabshah': 'Nawabshah',
                    'mirpur khas': 'Mirpur Khas',
                    'okara': 'Okara'
                };
                
                exactMatch = variations[query];
            }
            
            // If still no exact match, try partial match
            if (!exactMatch) {
                exactMatch = this.cities.find(city => 
                    city.toLowerCase().includes(query)
                );
            }
            
            if (exactMatch) {
                console.log('ðŸŽ¯ Found city match:', exactMatch);
                this.selectCity(exactMatch);
            } else {
                console.log('âŒ No city found for:', query);
                // Try to search with OpenWeather API directly
                this.searchCityDirectly(query);
            }
        },
        
        async searchCityDirectly(cityName) {
            console.log('ðŸŒ Searching city directly via API:', cityName);
            try {
                // Try to get weather data directly for the searched city
                const response = await fetch(`/api/current-weather/?city=${encodeURIComponent(cityName)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (!data.error) {
                        console.log('âœ… City found via weather API:', data.city);
                        // Add the city to our list if it's not already there
                        if (!this.cities.includes(data.city)) {
                            this.cities.push(data.city);
                        }
                        this.selectCity(data.city);
                        return;
                    }
                }
                console.log('âŒ No cities found via API');
            } catch (error) {
                console.error('âŒ Error searching city via API:', error);
            }
        },
        
        selectCity(city) {
            console.log('ðŸŽ¯ Selecting city:', city);
            this.selectedCity = city;
            this.searchQuery = city;
            this.showSearchResults = false;
            this.searchResults = [];
            console.log('âœ… City selected, loading forecast for:', this.selectedCity);
            this.loadForecast();
        },
        
        selectCityFromSearch(city) {
            this.selectCity(city);
        },
        

        // UV Index Level Helper
        getUVLevel(uvIndex) {
            if (uvIndex <= 2) return 'Low';
            if (uvIndex <= 5) return 'Moderate';
            if (uvIndex <= 7) return 'High';
            if (uvIndex <= 10) return 'Very High';
            return 'Extreme';
        },
        
        // Get timezone for a city
        getCityTimezone(cityName) {
            const timezoneMap = {
                // Major cities with their timezones
                'London': 'Europe/London',
                'New York': 'America/New_York',
                'Los Angeles': 'America/Los_Angeles',
                'Chicago': 'America/Chicago',
                'Toronto': 'America/Toronto',
                'Vancouver': 'America/Vancouver',
                'Tokyo': 'Asia/Tokyo',
                'Beijing': 'Asia/Shanghai',
                'Shanghai': 'Asia/Shanghai',
                'Hong Kong': 'Asia/Hong_Kong',
                'Seoul': 'Asia/Seoul',
                'Singapore': 'Asia/Singapore',
                'Bangkok': 'Asia/Bangkok',
                'Jakarta': 'Asia/Jakarta',
                'Manila': 'Asia/Manila',
                'Sydney': 'Australia/Sydney',
                'Melbourne': 'Australia/Melbourne',
                'Perth': 'Australia/Perth',
                'Auckland': 'Pacific/Auckland',
                'Dubai': 'Asia/Dubai',
                'Abu Dhabi': 'Asia/Dubai',
                'Riyadh': 'Asia/Riyadh',
                'Istanbul': 'Europe/Istanbul',
                'Moscow': 'Europe/Moscow',
                'Berlin': 'Europe/Berlin',
                'Paris': 'Europe/Paris',
                'Rome': 'Europe/Rome',
                'Madrid': 'Europe/Madrid',
                'Amsterdam': 'Europe/Amsterdam',
                'Brussels': 'Europe/Brussels',
                'Vienna': 'Europe/Vienna',
                'Prague': 'Europe/Prague',
                'Warsaw': 'Europe/Warsaw',
                'Budapest': 'Europe/Budapest',
                'Bucharest': 'Europe/Bucharest',
                'Sofia': 'Europe/Sofia',
                'Athens': 'Europe/Athens',
                'Cairo': 'Africa/Cairo',
                'Nairobi': 'Africa/Nairobi',
                'Lagos': 'Africa/Lagos',
                'Johannesburg': 'Africa/Johannesburg',
                'Casablanca': 'Africa/Casablanca',
                'Algiers': 'Africa/Algiers',
                'Tunis': 'Africa/Tunis',
                'Tripoli': 'Africa/Tripoli',
                'Khartoum': 'Africa/Khartoum',
                'Addis Ababa': 'Africa/Addis_Ababa',
                'Dar es Salaam': 'Africa/Dar_es_Salaam',
                'Kinshasa': 'Africa/Kinshasa',
                'Luanda': 'Africa/Luanda',
                'Lusaka': 'Africa/Lusaka',
                'Harare': 'Africa/Harare',
                'Gaborone': 'Africa/Gaborone',
                'Windhoek': 'Africa/Windhoek',
                'Maputo': 'Africa/Maputo',
                'Antananarivo': 'Indian/Antananarivo',
                'Port Louis': 'Indian/Mauritius',
                'Victoria': 'Indian/Mahe',
                'Moroni': 'Indian/Comoro',
                'Saint-Denis': 'Indian/Reunion',
                'Port-aux-FranÃ§ais': 'Indian/Kerguelen',
                'McMurdo Station': 'Antarctica/McMurdo',
                'Vostok Station': 'Antarctica/Vostok',
                'Amundsen-Scott Station': 'Antarctica/South_Pole',
                'Palmer Station': 'Antarctica/Palmer',
                'Rothera Station': 'Antarctica/Rothera',
                'Mawson Station': 'Antarctica/Mawson',
                'Davis Station': 'Antarctica/Davis',
                'Casey Station': 'Antarctica/Casey',
                'Dumont d\'Urville Station': 'Antarctica/DumontDUrville',
                'Concordia Station': 'Antarctica/McMurdo',
                'Halley Station': 'Antarctica/Halley',
                'Neumayer Station': 'Antarctica/Neumayer',
                'Troll Station': 'Antarctica/Troll',
                'Svea Station': 'Antarctica/Svea',
                'Wasa Station': 'Antarctica/Wasa',
                'Aboa Station': 'Antarctica/Aboa',
                'Maitri Station': 'Antarctica/Maitri',
                'Bharati Station': 'Antarctica/Bharati',
                'Dakshin Gangotri Station': 'Antarctica/Dakshin_Gangotri',
                'Himadri Station': 'Antarctica/Himadri',
                'Indira Station': 'Antarctica/Indira',
                'Karachi': 'Asia/Karachi',
                'Lahore': 'Asia/Karachi',
                'Islamabad': 'Asia/Karachi',
                'Gujranwala': 'Asia/Karachi',
                'Gujujranwala': 'Asia/Karachi', // Handle misspelling
                'Faisalabad': 'Asia/Karachi',
                'Rawalpindi': 'Asia/Karachi',
                'Multan': 'Asia/Karachi',
                'Peshawar': 'Asia/Karachi',
                'Quetta': 'Asia/Karachi',
                'Sialkot': 'Asia/Karachi',
                'Bahawalpur': 'Asia/Karachi',
                'Sargodha': 'Asia/Karachi',
                'Sukkur': 'Asia/Karachi',
                'Jhang': 'Asia/Karachi',
                'Sheikhupura': 'Asia/Karachi',
                'Rahim Yar Khan': 'Asia/Karachi',
                'Gujrat': 'Asia/Karachi',
                'Mardan': 'Asia/Karachi',
                'Kasur': 'Asia/Karachi',
                'Dera Ghazi Khan': 'Asia/Karachi',
                'Sahiwal': 'Asia/Karachi',
                'Nawabshah': 'Asia/Karachi',
                'Mirpur Khas': 'Asia/Karachi',
                'Okara': 'Asia/Karachi',
                'Bangalore': 'Asia/Kolkata',
                'Hyderabad': 'Asia/Kolkata',
                'Chennai': 'Asia/Kolkata',
                'Kolkata': 'Asia/Kolkata',
                'Ahmedabad': 'Asia/Kolkata',
                'Pune': 'Asia/Kolkata',
                'Jaipur': 'Asia/Kolkata',
                'Surat': 'Asia/Kolkata',
                'Lucknow': 'Asia/Kolkata',
                'Kanpur': 'Asia/Kolkata',
                'Nagpur': 'Asia/Kolkata',
                'Indore': 'Asia/Kolkata',
                'Thane': 'Asia/Kolkata',
                'Bhopal': 'Asia/Kolkata',
                'Patna': 'Asia/Kolkata',
                'Vadodara': 'Asia/Kolkata',
                'Ghaziabad': 'Asia/Kolkata',
                'Ludhiana': 'Asia/Kolkata',
                'Agra': 'Asia/Kolkata',
                'Nashik': 'Asia/Kolkata',
                'Faridabad': 'Asia/Kolkata',
                'Meerut': 'Asia/Kolkata',
                'Rajkot': 'Asia/Kolkata',
                'Kalyan': 'Asia/Kolkata',
                'Vasai': 'Asia/Kolkata',
                'Varanasi': 'Asia/Kolkata',
                'Srinagar': 'Asia/Kolkata',
                'Aurangabad': 'Asia/Kolkata',
                'Navi Mumbai': 'Asia/Kolkata',
                'Solapur': 'Asia/Kolkata'
            };
            
            // Return the timezone for the city, or default to UTC if not found
            return timezoneMap[cityName] || 'UTC';
        },
        
        // Fix city name spelling
        fixCityName(cityName) {
            const cityCorrections = {
                'Gujujranwala': 'Gujranwala',
                'Gujujranwala City Tehsil': 'Gujranwala City Tehsil',
                'Gujujranwala City': 'Gujranwala City',
                'Gujujranwala Tehsil': 'Gujranwala Tehsil'
            };
            
            return cityCorrections[cityName] || cityName;
        },
        
        
        
        async loadForecast() {
            if (!this.selectedCity) {
                console.error('âŒ No city selected for forecast');
                return;
            }
            
            console.log('ðŸš€ Loading forecast for city:', this.selectedCity);
            this.loading = true;
            
            try {
                // Get current weather
                console.log('ðŸŒ¤ï¸ Fetching current weather for:', this.selectedCity);
                const currentResponse = await fetch(`/api/current-weather/?city=${encodeURIComponent(this.selectedCity)}`);
                
                if (!currentResponse.ok) {
                    throw new Error(`Current weather API error: ${currentResponse.status} ${currentResponse.statusText}`);
                }
                
                const currentData = await currentResponse.json();
                console.log('âœ… Current weather data received:', currentData);
                
                // Get forecast
                console.log('ðŸ“… Fetching forecast for:', this.selectedCity);
                const forecastResponse = await fetch(`/api/weather-forecast/?city=${encodeURIComponent(this.selectedCity)}`);
                
                if (!forecastResponse.ok) {
                    throw new Error(`Forecast API error: ${forecastResponse.status} ${forecastResponse.statusText}`);
                }
                
                const forecastData = await forecastResponse.json();
                console.log('âœ… Forecast data received:', forecastData);
                
                if (currentData.error || forecastData.error) {
                    console.error('âŒ API returned error:', { current: currentData.error, forecast: forecastData.error });
                    return;
                }
                
                // Process forecast data to ensure proper hour-by-hour format with city timezone
                const cityTimezone = this.getCityTimezone(currentData.city);
                console.log('ðŸŒ City:', currentData.city, 'Timezone:', cityTimezone);
                
                const processedForecasts = forecastData.forecasts.map(forecast => {
                    // Ensure we have proper datetime handling
                    let forecastTime, forecastDate, timestamp;
                    
                    if (forecast.datetime) {
                        const date = new Date(forecast.datetime);
                        // Convert to city's local timezone
                        forecastTime = date.toLocaleTimeString('en-US', {
                            hour: '2-digit', 
                            minute: '2-digit',
                            timeZone: cityTimezone
                        });
                        forecastDate = date.toLocaleDateString('en-US', {
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric',
                            timeZone: cityTimezone
                        });
                        timestamp = date.getTime();
                        
                        // Debug logging for timezone conversion
                        console.log('ðŸ• Original:', date.toISOString(), 'City Time:', forecastTime, 'City Date:', forecastDate);
                    } else if (forecast.dt) {
                        // Handle Unix timestamp
                        const date = new Date(forecast.dt * 1000);
                        // Convert to city's local timezone
                        forecastTime = date.toLocaleTimeString('en-US', {
                            hour: '2-digit', 
                            minute: '2-digit',
                            timeZone: cityTimezone
                        });
                        forecastDate = date.toLocaleDateString('en-US', {
                            weekday: 'short', 
                            month: 'short', 
                            day: 'numeric',
                            timeZone: cityTimezone
                        });
                        timestamp = date.getTime();
                        
                        // Debug logging for timezone conversion
                        console.log('ðŸ• Original:', date.toISOString(), 'City Time:', forecastTime, 'City Date:', forecastDate);
                    } else {
                        forecastTime = '--';
                        forecastDate = '--';
                        timestamp = 0;
                    }
                    
                    return {
                        ...forecast,
                        time: forecastTime,
                        date: forecastDate,
                        timestamp: timestamp
                    };
                });
                
                // Sort forecasts by timestamp to ensure chronological order
                processedForecasts.sort((a, b) => a.timestamp - b.timestamp);
                
                // Fix city name spelling
                const correctedCityName = this.fixCityName(currentData.city);
                
                this.forecastData = {
                    city: correctedCityName,
                    current: {
                        ...currentData,
                        city: correctedCityName
                    },
                    forecasts: processedForecasts
                };
                
                console.log('ðŸŽ‰ Forecast data updated successfully:', this.forecastData);
                
                // Update chart after data is loaded
                this.updateForecastChart();
            } catch (error) {
                console.error('âŒ Error fetching forecast data:', error);
                // Show user-friendly error message
                this.forecastData = {
                    city: this.selectedCity,
                    error: `Failed to load weather data: ${error.message}`
                };
            } finally {
                this.loading = false;
            }
        },
        
        updateForecastChart() {
            if (window.forecastChart && typeof window.forecastChart.destroy === 'function') {
                window.forecastChart.destroy();
            }
            
            if (!this.forecastData || !this.forecastData.forecasts) return;
            
            const forecasts = this.forecastData.forecasts.slice(0, 24);
            const labels = forecasts.map(f => {
                if (f.datetime) {
                    return new Date(f.datetime).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        timeZone: this.getCityTimezone(this.forecastData.city)
                    });
                } else if (f.dt) {
                    return new Date(f.dt * 1000).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        timeZone: this.getCityTimezone(this.forecastData.city)
                    });
                }
                return '--';
            });
            const temperatures = forecasts.map(f => f.temperature);
            const humidity = forecasts.map(f => f.humidity);
            const windSpeed = forecasts.map(f => f.wind_speed);
            
            const ctx = document.getElementById('forecastChart');
            if (ctx) {
                window.forecastChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
                        labels: labels,
            datasets: [
                {
                    label: 'Temperature (Â°C)',
                                data: temperatures,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    yAxisID: 'y',
                                tension: 0.4
                },
                {
                    label: 'Humidity (%)',
                                data: humidity,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    yAxisID: 'y1',
                                tension: 0.4
                            },
                            {
                                label: 'Wind Speed (m/s)',
                                data: windSpeed,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                yAxisID: 'y2',
                                tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff'
                            }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                                    text: 'Time (24 hours)'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Temperature (Â°C)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Humidity (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Wind Speed (m/s)'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                }
            }
        }
    });
}
        }
    }));
});

// Forecast is now initialized using Alpine.js x-init directive
</script>
{% endblock %}
